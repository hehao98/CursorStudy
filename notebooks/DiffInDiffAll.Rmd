---
title: "The Impact of Cursor Adoption on Velocity and Quality - All DiD Methods Comparison"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Loading Required Packages

```{r load_packages}
library(did)
library(didimputation)
library(fixest)
library(tidyverse)
library(ggplot2)
library(data.table)
library(gridExtra)
library(knitr)
library(kableExtra)
```

## Loading and Preparing the Data

```{r load_data}
panel_data <- fread("../data/panel_event_monthly.csv")

# panel_data <- panel_data[panel_data$commits > 0]

# Convert variables to DiD required format
panel_data$repo_name <- as.numeric(factor(panel_data$repo_name))
panel_data$time <- as.numeric(gsub("-", "", panel_data$time))
panel_data$event[!is.na(panel_data$event)] <- as.numeric(
    gsub("-", "", panel_data$event[!is.na(panel_data$event)]))
panel_data$event[is.na(panel_data$event)] <- 0
panel_data <- panel_data[panel_data$event < 202401 # never treated
        | (panel_data$event > 202407 & panel_data$event <= 202503)]
panel_data$event <- as.integer(panel_data$event)

# Create delta metrics before log transformation
# First, sort data and compute changes from previous time point
panel_data <- panel_data %>%
    arrange(repo_name, time) %>%
    group_by(repo_name) %>%
    mutate(
        # Compute changes from previous time point
        delta_code_smells = code_smells - lag(code_smells, default = 0),
        delta_vulnerabilities = vulnerabilities - lag(vulnerabilities, default = 0),
        delta_bugs = bugs - lag(bugs, default = 0),

        # Compute delta per line added (avoid division by zero)
        code_smells_per_line = delta_code_smells / (lines_added + 1),
        vulnerabilities_per_line = delta_vulnerabilities / (lines_added + 1),
        bugs_per_line = delta_bugs / (lines_added + 1)
    ) %>%
    ungroup()

# Log transform skewed variables
panel_data$commits <- log(panel_data$commits + 1)
panel_data$lines_added <- log(panel_data$lines_added + 1)
panel_data$code_smells <- log(panel_data$code_smells + 1)
panel_data$vulnerabilities <- log(panel_data$vulnerabilities + 1)
panel_data$bugs <- log(panel_data$bugs + 1)
panel_data$cognitive_complexity <- log(panel_data$cognitive_complexity + 1)
panel_data$duplicated_lines_density <- log(panel_data$duplicated_lines_density + 1)
panel_data$comment_lines_density <- log(panel_data$comment_lines_density + 1)
panel_data$age <- log(panel_data$age + 1)
panel_data$contributors <- log(panel_data$contributors + 1)
panel_data$stars <- log(panel_data$stars + 1)
panel_data$issues <- log(panel_data$issues + 1)
panel_data$issue_comments <- log(panel_data$issue_comments + 1)

# Handle delta metrics transformation (can be negative, so use signed log)
# Use signed log transformation: sign(x) * log(|x| + 1)
panel_data$code_smells_per_line <- sign(panel_data$code_smells_per_line) * log(abs(panel_data$code_smells_per_line) + 1)
panel_data$vulnerabilities_per_line <- sign(panel_data$vulnerabilities_per_line) * log(abs(panel_data$vulnerabilities_per_line) + 1)
panel_data$bugs_per_line <- sign(panel_data$bugs_per_line) * log(abs(panel_data$bugs_per_line) + 1)

# For TWFE method
panel_data$post_event <- ifelse(panel_data$time >= panel_data$event & panel_data$event > 0, 1, 0)
panel_data$repo_name_fac <- as.factor(panel_data$repo_name)
panel_data$time_fac <- as.factor(panel_data$time)

# Create lead/lag variables for TWFE event study
panel_data <- panel_data %>%
    arrange(repo_name, time) %>%
    group_by(repo_name) %>%
    mutate(
        lead_6 = ifelse(time == event - 6, 1, 0),
        lead_5 = ifelse(time == event - 5, 1, 0),
        lead_4 = ifelse(time == event - 4, 1, 0),
        lead_3 = ifelse(time == event - 3, 1, 0),
        lead_2 = ifelse(time == event - 2, 1, 0),
        lag_0 = ifelse(time == event, 1, 0),
        lag_1 = ifelse(time == event + 1, 1, 0),
        lag_2 = ifelse(time == event + 2, 1, 0),
        lag_3 = ifelse(time == event + 3, 1, 0),
        lag_4 = ifelse(time == event + 4, 1, 0),
        lag_5 = ifelse(time == event + 5, 1, 0),
        lag_6 = ifelse(time == event + 6, 1, 0)
    ) %>%
    ungroup()
```

## Define Outcome Variables

```{r define_outcomes}
outcome_vars <- c(
    "commits",
    "lines_added",
    "code_smells",
    "vulnerabilities",
    "bugs",
    "comment_lines_density",
    "duplicated_lines_density",
    "cognitive_complexity",
    "code_smells_per_line",
    "vulnerabilities_per_line",
    "bugs_per_line"
)
outcome_names <- c(
    "Commits",
    "Lines Added",
    "Code Smells",
    "Vulnerabilities",
    "Bugs",
    "% Comment Lines",
    "% Duplicated Lines",
    "Cognitive Complexity",
    "\u0394 Code Smells per Line Added",
    "\u0394 Vulnerabilities per Line Added",
    "\u0394 Bugs per Line Added"
)
```

## Run All Three DiD Methods

```{r run_methods}
# Function to run Callaway & Sant'Anna method
run_callaway <- function(outcome_var, data) {
    result <- att_gt(
        yname = outcome_var,
        gname = "event",
        idname = "repo_name",
        tname = "time",
        xformla = ~ age + ncloc + contributors + stars + issues,
        data = data,
        panel = TRUE,
        allow_unbalanced_panel = TRUE,
        anticipation = 1
    )
    return(result)
}

# Function to run Borusyak et al. method
run_borusyak <- function(outcome_var, data) {
    result <- did_imputation(
        data = data,
        yname = outcome_var,
        gname = "event",
        tname = "time",
        idname = "repo_name",
        first_stage = ~ age + ncloc + contributors + stars + issues | repo_name + time
    )
    return(result)
}

# Function to run TWFE method
run_twfe <- function(outcome_var, data) {
    formula_str <- paste0(
        outcome_var, " ~ post_event + age + ncloc + contributors + stars + issues | repo_name_fac + time_fac"
    )
    model <- feols(as.formula(formula_str), data = data)
    return(model)
}

# Run all methods for each outcome
callaway_results <- list()
borusyak_results <- list()
twfe_results <- list()

for (var in outcome_vars) {
    callaway_results[[var]] <- run_callaway(var, panel_data)
    borusyak_results[[var]] <- run_borusyak(var, panel_data)
    twfe_results[[var]] <- run_twfe(var, panel_data)
}
```

## Static Treatment Effects Comparison

```{r static_effects, fig.width=5, fig.height=5}
# Extract static effects from each method
extract_static_effects <- function(results, method_name, variables = NULL) {
    effects_list <- list()

    # Use provided variables or default to outcome_vars
    vars_to_use <- if (is.null(variables)) outcome_vars else variables

    for (var in vars_to_use) {
        if (method_name == "Callaway and Sant'Anna") {
            agg <- aggte(results[[var]], type = "simple")
            effects_list[[var]] <- data.frame(
                outcome = var,
                method = method_name,
                estimate = agg$overall.att,
                se = agg$overall.se,
                conf.low = agg$overall.att - 1.96 * agg$overall.se,
                conf.high = agg$overall.att + 1.96 * agg$overall.se
            )
        } else if (method_name == "Borusyak et al.") {
            result <- results[[var]]
            treat_row <- result[result$term == "treat", ]
            effects_list[[var]] <- data.frame(
                outcome = var,
                method = method_name,
                estimate = treat_row$estimate,
                se = treat_row$std.error,
                conf.low = treat_row$conf.low,
                conf.high = treat_row$conf.high
            )
        } else if (method_name == "TWFE") {
            coef_table <- summary(results[[var]])$coeftable
            effects_list[[var]] <- data.frame(
                outcome = var,
                method = method_name,
                estimate = coef_table["post_event", "Estimate"],
                se = coef_table["post_event", "Std. Error"],
                conf.low = coef_table["post_event", "Estimate"] - 1.96 * coef_table["post_event", "Std. Error"],
                conf.high = coef_table["post_event", "Estimate"] + 1.96 * coef_table["post_event", "Std. Error"]
            )
        }
    }

    return(do.call(rbind, effects_list))
}

# Combine all static effects (reorder with Callaway last)
static_effects <- rbind(
    extract_static_effects(twfe_results, "TWFE"),
    extract_static_effects(borusyak_results, "Borusyak et al."),
    extract_static_effects(callaway_results, "Callaway and Sant'Anna")
)

# Create factor for proper ordering and labeling
static_effects$outcome <- factor(static_effects$outcome,
                                 levels = outcome_vars,
                                 labels = outcome_names)

# Create comparison plot with colorblind-friendly palette
static_plot <- ggplot(static_effects, aes(x = outcome, y = estimate, color = method)) +
    geom_point(position = position_dodge(width = 0.3), size = 3) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                  position = position_dodge(width = 0.3), width = 0.2) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red", size = 1) +
    scale_color_manual(values = c(
        "TWFE" = "#CC79A7",                    # Colorblind-friendly pink
        "Borusyak et al." = "#009E73",         # Colorblind-friendly green
        "Callaway and Sant'Anna" = "#0072B2"   # Colorblind-friendly blue
    )) +
    labs(
        x = "Outcome",
        y = "Treatment Effect",
        color = "Estimator"
    ) +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
        axis.title.x = element_text(size = 9),
        axis.title.y = element_text(size = 9),
        axis.text.y = element_text(size = 8),
        panel.grid = element_blank(),
        axis.line = element_line(color = "black", size = 0.3),
        axis.ticks = element_line(color = "black", size = 0.3),
        legend.position = "top"
    )

print(static_plot)

ggsave("../plots/static_effects.pdf",
  plot = static_plot, width = 5, height = 5,
  device = cairo_pdf)
```

## Static Treatment Effects Table

```{r static_effects_table}
# Add significance levels and formatting
static_table <- static_effects %>%
    mutate(
        # Calculate p-values (two-tailed test)
        z_stat = estimate / se,
        p_value = 2 * (1 - pnorm(abs(z_stat))),

        # Create significance stars
        significance = case_when(
            p_value < 0.001 ~ "***",
            p_value < 0.01 ~ "**",
            p_value < 0.05 ~ "*",
            p_value < 0.1 ~ ".",
            TRUE ~ ""
        ),

        # Format estimates and standard errors
        estimate_formatted = sprintf("%.4f", estimate),
        se_formatted = sprintf("(%.4f)", se),

        # Combine estimate with significance
        estimate_sig = paste0(estimate_formatted, significance)
    ) %>%
    select(outcome, method, estimate_sig, se_formatted, p_value) %>%
    arrange(outcome, method)

# Reshape to wide format for better presentation
static_table_wide <- static_table %>%
    pivot_wider(
        id_cols = outcome,
        names_from = method,
        values_from = c(estimate_sig, se_formatted),
        names_sep = "_"
    ) %>%
    select(
        outcome,
        `estimate_sig_TWFE`, `se_formatted_TWFE`,
        `estimate_sig_Borusyak et al.`, `se_formatted_Borusyak et al.`,
        `estimate_sig_Callaway and Sant'Anna`, `se_formatted_Callaway and Sant'Anna`
    )

# Create the final table
kable(static_table_wide,
      col.names = c("Outcome",
                    "Estimate", "Std. Error",
                    "Estimate", "Std. Error",
                    "Estimate", "Std. Error"),
      caption = "Static Treatment Effects: Impact of Cursor Adoption",
      align = c("l", rep("r", 6))) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                  full_width = FALSE,
                  font_size = 12) %>%
    add_header_above(c(" " = 1, "TWFE" = 2, "Borusyak et al." = 2, "Callaway and Sant'Anna" = 2)) %>%
    footnote(general = "Significance levels: *** p<0.001, ** p<0.01, * p<0.05, . p<0.1",
             general_title = "Note:")
```

## Dynamic Treatment Effects (Event Study) Comparison

```{r dynamic_effects, fig.width=10.5, fig.height=7.5}
# Extract dynamic effects from each method
extract_dynamic_effects <- function(results, method_name, variables = NULL) {
    effects_list <- list()

    # Use provided variables or default to outcome_vars
    vars_to_use <- if (is.null(variables)) outcome_vars else variables

    for (var in vars_to_use) {
        if (method_name == "Callaway and Sant'Anna") {
            dynamic_effects <- aggte(results[[var]], type = "dynamic", min_e = -6, max_e = 6)
            effects_list[[var]] <- data.frame(
                outcome = var,
                method = method_name,
                time = dynamic_effects$egt,
                estimate = dynamic_effects$att.egt,
                conf.low = dynamic_effects$att.egt - 1.96 * dynamic_effects$se.egt,
                conf.high = dynamic_effects$att.egt + 1.96 * dynamic_effects$se.egt
            )
        } else if (method_name == "Borusyak et al.") {
            result <- results[[var]]
            dynamic_data <- result[result$term != "treat", ]
            effects_list[[var]] <- data.frame(
                outcome = var,
                method = method_name,
                time = as.numeric(dynamic_data$term),
                estimate = dynamic_data$estimate,
                conf.low = dynamic_data$conf.low,
                conf.high = dynamic_data$conf.high
            )
        } else if (method_name == "Two Way Fixed Effects") {
            # Run event study for TWFE
            formula_str <- paste0(
                var, " ~ lead_6 + lead_5 + lead_4 + lead_3 + lead_2 + ",
                "lag_0 + lag_1 + lag_2 + lag_3 + lag_4 + lag_5 + lag_6 + ",
                "age + ncloc + contributors + stars + issues | repo_name_fac + time_fac"
            )
            event_model <- feols(as.formula(formula_str), data = panel_data)

            coefs <- coef(event_model)
            ci <- confint(event_model)

            time_periods <- c(-6:6)
            estimates <- numeric(length(time_periods))
            conf_low <- numeric(length(time_periods))
            conf_high <- numeric(length(time_periods))

            for (i in seq_along(time_periods)) {
                t <- time_periods[i]
                var_name <- if (t < 0) paste0("lead_", abs(t)) else paste0("lag_", t)

                estimates[i] <- coefs[var_name]
                conf_low[i] <- ci[var_name, 1]
                conf_high[i] <- ci[var_name, 2]
            }

            effects_list[[var]] <- data.frame(
                outcome = var,
                method = method_name,
                time = time_periods,
                estimate = estimates,
                conf.low = conf_low,
                conf.high = conf_high
            )
        }
    }

    return(do.call(rbind, effects_list))
}

# Run dynamic analysis for Callaway and Borusyak
callaway_dynamic <- list()
borusyak_dynamic <- list()

for (var in outcome_vars) {
    callaway_dynamic[[var]] <- run_callaway(var, panel_data)

    borusyak_dynamic[[var]] <- did_imputation(
        data = panel_data,
        yname = var,
        gname = "event",
        tname = "time",
        idname = "repo_name",
        first_stage = ~ age + ncloc + contributors + stars + issues | repo_name + time,
        horizon = -6:6,
        pretrends = -6:-1
    )
}

# Combine all dynamic effects (reorder with Callaway last)
dynamic_effects <- rbind(
    extract_dynamic_effects(twfe_results, "Two Way Fixed Effects"),
    extract_dynamic_effects(borusyak_dynamic, "Borusyak et al."),
    extract_dynamic_effects(callaway_dynamic, "Callaway and Sant'Anna")
)

# Create factor for proper ordering and labeling
dynamic_effects$outcome <- factor(dynamic_effects$outcome,
                                  levels = outcome_vars,
                                  labels = outcome_names)

# Add significance indicators for visual styling
dynamic_effects <- dynamic_effects %>%
    mutate(
        # Calculate standard error from confidence intervals (approximate)
        se = (conf.high - conf.low) / (2 * 1.96),
        # Calculate z-statistic
        z_stat = estimate / se,
        # Calculate p-value (two-tailed)
        p_value = 2 * (1 - pnorm(abs(z_stat))),
        # Create significance indicator
        significant = p_value < 0.05,
        # Create aesthetic variables
        point_shape = ifelse(significant, 19, 21),  # filled vs hollow circles
        line_type = ifelse(significant, "solid", "dotted")
    )

# Create comparison plot with significance-based styling
dynamic_plot <- ggplot(dynamic_effects, aes(x = time, y = estimate, color = method)) +
    # Add significant points (filled)
    geom_point(data = filter(dynamic_effects, significant),
               position = position_dodge(width = 0.5), size = 2, shape = 19) +
    # Add non-significant points (hollow)
    geom_point(data = filter(dynamic_effects, !significant),
               position = position_dodge(width = 0.5), size = 2, shape = 21, fill = "transparent") +
    # Add error bars for significant effects (solid)
    geom_errorbar(data = filter(dynamic_effects, significant),
                  aes(ymin = conf.low, ymax = conf.high),
                  position = position_dodge(width = 0.5), width = 0, linetype = "solid") +
    # Add error bars for non-significant effects (dotted)
    geom_errorbar(data = filter(dynamic_effects, !significant),
                  aes(ymin = conf.low, ymax = conf.high),
                  position = position_dodge(width = 0.5), width = 0, linetype = "dotted") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "blue") +
    scale_color_manual(values = c(
        "Two Way Fixed Effects" = "#CC79A7",                    # Colorblind-friendly pink
        "Borusyak et al." = "#009E73",         # Colorblind-friendly green
        "Callaway and Sant'Anna" = "#0072B2"   # Colorblind-friendly blue
    )) +
    facet_wrap(~outcome, scales = "free_y", ncol = 4) +
    scale_x_continuous(limits = c(-6, 6), breaks = -6:6) +
    labs(
        x = "Months Relative to Cursor Adoption",
        y = "Treatment Effect",
        color = "Estimator",
        caption = "Filled dots: p < 0.05 (significant), Hollow dots: p ≥ 0.05 (non-significant)"
    ) +
    theme_minimal() +
    theme(
        legend.position = "bottom",
        plot.caption = element_text(hjust = 0.5, size = 10, margin = margin(t = 10)),
        legend.margin = margin(b = 5)
    )

print(dynamic_plot)

ggsave("../plots/dynamic_effects.pdf",
  plot = dynamic_plot, width = 10.5, height = 7.5,
  device = cairo_pdf)
```
