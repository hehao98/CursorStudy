---
title: "The Impact of Cursor Adoption on Velocity and Quality"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Loading Required Packages

```{r load_packages}
library(fixest)
library(tidyverse)
library(ggplot2)
library(data.table)
library(modelsummary)
```

## Loading and Preparing the Data

```{r load_data}
panel_data <- fread("../data/panel_event_weekly.csv")

panel_data$repo_name <- as.factor(panel_data$repo_name)
panel_data$time <- as.factor(panel_data$time)

glimpse(panel_data)
```

## Base DiD Model

```{r base_did_model}
fit_did_model <- function(outcome_var, data) {
    formula_str <- paste0(
        outcome_var, " ~ post_event + log(ncloc + 1) + log(age + 1) +
    log(contributors + 1) + log(stars + 1) +
    log(issues + 1) + log(issue_comments + 1) | repo_name + time"
    )

    model <- feols(as.formula(formula_str), data = data)
    return(model)
}

fit_multiple_did_models <- function(outcome_vars, data) {
    models_list <- list()

    for (outcome in names(outcome_vars)) {
        models_list[[outcome_vars[outcome]]] <- fit_did_model(outcome, data)
    }

    return(models_list)
}

outcome_variables <- c(
    "log(commits + 1)" = "Commits",
    "log(lines_added + 1)" = "Lines Added",
    "log(code_smells + 1)" = "Code Smells",
    "log(vulnerabilities + 1)" = "Vulnerabilities",
    "log(bugs + 1)" = "Bugs",
    "comment_lines_density" = "Comment Lines Density",
    "duplicated_lines_density" = "Duplicated Lines",
    "log(cognitive_complexity + 1)" = "Cognitive Complexity"
)

did_models <- fit_multiple_did_models(outcome_variables, panel_data)

modelsummary(did_models,
    title = "Impact of Cursor Adoption on Development Metrics",
    stars = TRUE,
    gof_omit = "AIC|BIC|RMSE|FE|R2 Within Adj.|(R2$)|Std",
    coef_map = c(
        "post_event" = "Post Cursor Adoption",
        "log(ncloc + 1)" = "Log Lines of Code",
        "log(age + 1)" = "Log Age (days)",
        "log(contributors + 1)" = "Log Contributors",
        "log(stars + 1)" = "Log Stars",
        "log(issues + 1)" = "Log Issues",
        "log(issue_comments + 1)" = "Log Issue Comments"
    ),
    fmt = 3,
    estimate = "{estimate}{stars}"
)
```
## Panel Event Study Models

```{r panel_event_study, fig.width=12, fig.height=8}
# Define lead and lag parameters
max_lead <- 30  # Maximum number of lead periods
max_lag <- 30   # Maximum number of lag periods

# Function to fit event study model
fit_event_study <- function(outcome_var, data, max_lead = 6, max_lag = 6) {
    # Generate lead terms
    lead_terms <- if(max_lead > 0) {
        paste0("lead_", max_lead:2, collapse = " + ")
    } else {
        ""
    }

    # Generate lag terms
    lag_terms <- if(max_lag > 0) {
        paste0("lag_", 0:max_lag, collapse = " + ")
    } else {
        ""
    }

    # Combine terms with proper spacing
    all_terms <- paste(c(lead_terms, lag_terms), collapse = " + ")

    formula_str <- paste0(
        outcome_var, " ~ ", all_terms, " +
        log(ncloc + 1) + log(age + 1) + log(contributors + 1) + log(stars + 1) +
        log(issues + 1) + log(issue_comments + 1) | repo_name + time"
    )

    model <- feols(as.formula(formula_str), data = data)
    return(model)
}

# Fit models for each outcome
event_models <- list(
    commits = fit_event_study("log(commits + 1)", panel_data, max_lead, max_lag),
    lines = fit_event_study("log(lines_added + 1)", panel_data, max_lead, max_lag),
    complexity = fit_event_study("log(cognitive_complexity + 1)", panel_data, max_lead, max_lag),
    code_smells = fit_event_study("log(code_smells + 1)", panel_data, max_lead, max_lag)
)

# Function to extract coefficients and CIs
get_event_data <- function(model, outcome_name, max_lead = 6, max_lag = 6) {
    coefs <- coef(model)
    ci <- confint(model)
    pvals <- summary(model)$coeftable[, 4]

    # Generate time periods based on lead and lag values
    time_periods <- c()
    if(max_lead > 0) time_periods <- c(time_periods, -max_lead:-1)
    if(max_lag > 0) time_periods <- c(time_periods, 0:max_lag)

    estimates <- numeric(length(time_periods))
    conf_low <- numeric(length(time_periods))
    conf_high <- numeric(length(time_periods))
    p_values <- numeric(length(time_periods))
    is_significant <- logical(length(time_periods))

    for (i in seq_along(time_periods)) {
        t <- time_periods[i]
        var_name <- if (t < 0) paste0("lead_", abs(t)) else paste0("lag_", t)

        # Check if the coefficient exists in the model
        if(var_name %in% names(coefs)) {
            estimates[i] <- coefs[var_name]
            conf_low[i] <- ci[var_name, 1]
            conf_high[i] <- ci[var_name, 2]
            p_values[i] <- pvals[var_name]
            is_significant[i] <- p_values[i] < 0.05
        } else {
            estimates[i] <- NA
            conf_low[i] <- NA
            conf_high[i] <- NA
            p_values[i] <- NA
            is_significant[i] <- NA
        }
    }

    data.frame(
        time = time_periods,
        estimate = estimates,
        conf.low = conf_low,
        conf.high = conf_high,
        p_value = p_values,
        is_significant = is_significant,
        outcome = outcome_name
    )
}

# Combine all results
plot_data <- rbind(
    get_event_data(event_models$commits, "Commits", max_lead, max_lag),
    get_event_data(event_models$lines, "Lines Added", max_lead, max_lag),
    get_event_data(event_models$complexity, "Cognitive Complexity", max_lead, max_lag),
    get_event_data(event_models$code_smells, "Code Smells", max_lead, max_lag)
)

# Plot all outcomes
ggplot(plot_data, aes(x = time, y = estimate, color = outcome)) +
    # Use different shapes based on significance
    geom_point(aes(shape = is_significant), size = 3, position = position_dodge(width = 0.3)) +
    scale_shape_manual(values = c("FALSE" = 1, "TRUE" = 16)) + # 1=hollow circle, 16=filled circle
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
        width = 0.2,
        position = position_dodge(width = 0.3)
    ) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "blue") +
    facet_wrap(~outcome, scales = "free_y") +
    labs(
        title = "Event Study: Effects of Cursor Adoption",
        x = "Months Relative to Adoption",
        y = "Coefficient Estimate",
        color = "Outcome",
        shape = "Significant (p<0.05)"
    ) +
    theme_minimal() +
    theme(
        legend.position = "bottom",
        legend.box = "horizontal"
    )
```
