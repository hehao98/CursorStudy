---
title: "Cursor Adoption Time Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 5, fig.height = 3)
knitr::opts_chunk$set(dev = 'CairoPNG', dpi = 150)
options(bitmapType = 'cairo')
```

```{r}
# Import necessary libraries
library(tidyverse)
library(lubridate)
library(scales)
library(Cairo)

# Set global ggplot theme - black axis lines, no grid
theme_set(theme_minimal() +
          theme(panel.grid = element_blank(),
                axis.line = element_line(color = "black"),
                axis.ticks = element_line(color = "black")))
```

## Data Loading and Exploration

```{r}
# Load the datasets
repos_path <- "../data/repos.csv"
metrics_path <- "../data/repo_metrics.csv"

repos_df <- read_csv(repos_path)
metrics_df <- read_csv(metrics_path)

# Display basic info
print(glue::glue("Repos: {nrow(repos_df)} rows x {ncol(repos_df)} columns"))
print(glue::glue("Metrics: {nrow(metrics_df)} rows x {ncol(metrics_df)} columns"))

# Convert datetime columns
repos_df <- repos_df %>%
    mutate(
        repo_created = ymd_hms(repo_created),
        repo_updated = ymd_hms(repo_updated)
    )

metrics_df <- metrics_df %>%
    mutate(
        cursor_adoption_time = ymd_hms(cursor_adoption_time),
        adoption_yearmonth = format(cursor_adoption_time, "%Y-%m")
    ) %>%
    filter(!is.na(cursor_adoption_time)) %>%
    filter(cursor_adoption_time < ymd("2025-04-01")) %>%
    filter(cursor_adoption_time >= ymd("2024-01-01"))

# View data structure
glimpse(metrics_df)
```

## Distribution of Cursor Adoption Time

```{r}
# Plot cursor adoption over time (by year-month) with bar chart and numbers on top
adoption_counts <- metrics_df %>%
    count(adoption_yearmonth) %>%
    arrange(adoption_yearmonth)

p <- ggplot(adoption_counts, aes(x = adoption_yearmonth, y = n)) +
    geom_bar(stat = "identity", fill = "#0072B2", alpha = 0.7) +
    geom_text(aes(label = n), vjust = -0.5, size = 3) +
    labs(
        #title = "Cursor Adoption Over Time",
        x = "Year-Month",
        y = "Number of Repositories"
    ) +
    scale_y_continuous(expand = c(0, 0)) +
    coord_cartesian(ylim = c(0, 330), clip = "off") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p)

ggsave("../plots/cursor_adoption_time.pdf", plot = p, width = 5, height = 2.5, device = CairoPDF, family = "DejaVu Sans")
```

## Distribution of Repository Creation Time

```{r, fig.width = 9}
# Create year-quarter field for repository creation dates
repos_df <- repos_df %>%
    mutate(
        # Extract quarter (Q1, Q2, Q3, Q4) from date
        quarter = paste0("Q", ceiling(month(repo_created)/3)),
        # Format as YYYY-QN
        creation_yearquarter = paste0(year(repo_created), "-", quarter)
    )

# Plot repo creation over time (by year-quarter) with bar chart and numbers on top
creation_counts <- repos_df %>%
    count(creation_yearquarter) %>%
    arrange(creation_yearquarter)

p2 <- ggplot(creation_counts, aes(x = creation_yearquarter, y = n)) +
    geom_bar(stat = "identity", fill = "#009E73", alpha = 0.8) +
    geom_text(aes(label = n), vjust = -0.5, size = 3) +
    labs(
        x = "Year-Quarter",
        y = "Number of Repositories"
    ) +
    scale_y_continuous(expand = c(0, 0)) +
    coord_cartesian(ylim = c(0, max(creation_counts$n) * 1.1), clip = "off") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p2)

ggsave("../plots/repo_creation_time.pdf", plot = p2, width = 9, height = 3, device = CairoPDF, family = "DejaVu Sans")
```
