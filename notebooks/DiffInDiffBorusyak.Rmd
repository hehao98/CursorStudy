---
title: "The Impact of Cursor Adoption on Velocity and Quality - Borusyak et al. (2021) DiD Approach"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Loading Required Packages

```{r load_packages}
library(didimputation)
library(tidyverse)
library(ggplot2)
library(data.table)
library(modelsummary)
library(fixest)
library(gridExtra)
```

## Loading and Preparing the Data

```{r load_data}
panel_data <- fread("../data/panel_event_monthly.csv")

# panel_data <- panel_data[panel_data$commits > 0]

# Convert variables to DiD required format
panel_data$repo_name <- as.numeric(factor(panel_data$repo_name))
panel_data$time <- as.numeric(gsub("-", "", panel_data$time))
panel_data$event[!is.na(panel_data$event)] <- as.numeric(
    gsub("-", "", panel_data$event[!is.na(panel_data$event)]))
panel_data$event[is.na(panel_data$event)] <- 0
panel_data <- panel_data[panel_data$event < 202401 # never treated
        | (panel_data$event > 202407 & panel_data$event <= 202503)]
panel_data$event <- as.integer(panel_data$event)

# Log transform skewed variables
panel_data$commits <- log(panel_data$commits + 1)
panel_data$lines_added <- log(panel_data$lines_added + 1)
panel_data$code_smells <- log(panel_data$code_smells + 1)
panel_data$vulnerabilities <- log(panel_data$vulnerabilities + 1)
panel_data$bugs <- log(panel_data$bugs + 1)
panel_data$cognitive_complexity <- log(panel_data$cognitive_complexity + 1)
panel_data$age <- log(panel_data$age + 1)
panel_data$contributors <- log(panel_data$contributors + 1)
panel_data$stars <- log(panel_data$stars + 1)
panel_data$issues <- log(panel_data$issues + 1)
panel_data$issue_comments <- log(panel_data$issue_comments + 1)

# Create treatment indicator and time since treatment variables
panel_data$treated <- ifelse(panel_data$event > 0, 1, 0)
panel_data$time_since_treatment <- ifelse(panel_data$treated == 1,
                                         panel_data$time - panel_data$event,
                                         NA)

glimpse(panel_data)
```

## DiD Analysis with DiD Imputation Package

```{r did_analysis}
# List of outcome variables
outcome_vars <- c(
    "commits",
    "lines_added",
    "code_smells",
    "vulnerabilities",
    "bugs",
    "comment_lines_density",
    "duplicated_lines_density",
    "cognitive_complexity"
)
outcome_names <- c(
    "Commits",
    "Lines Added",
    "Code Smells",
    "Vulnerabilities",
    "Bugs",
    "Comment Lines Density",
    "Duplicated Lines Density",
    "Cognitive Complexity"
)
```

## Aggregate Treatment Effects

```{r aggregate_effects}
# Function to extract static treatment effects (overall effect)
get_static_effects <- function(outcome_var, data) {
    # Run static DiD (no horizon/pretrends specified)
    static_result <- did_imputation(
        data = data,
        yname = outcome_var,
        gname = "event",
        tname = "time",
        idname = "repo_name",
        first_stage = ~ age + ncloc + contributors + stars + issues | repo_name + time
    )

    return(static_result)
}

# Calculate static effects for each outcome
static_results <- list()
for (var in outcome_vars) {
    cat("Running static analysis for:", var, "\n")
    static_results[[var]] <- get_static_effects(var, panel_data)
}

# Create a dataframe with all static effects
static_df <- data.frame(
    Outcome = names(static_results),
    Estimate = sapply(static_results, function(x) x$estimate[x$term == "treat"]),
    SE = sapply(static_results, function(x) x$std.error[x$term == "treat"]),
    CI_Lower = sapply(static_results, function(x) x$conf.low[x$term == "treat"]),
    CI_Upper = sapply(static_results, function(x) x$conf.high[x$term == "treat"])
)

# Clean outcome names for display
static_df$Outcome <- gsub("log\\((.+) \\+ 1\\)", "\\1", static_df$Outcome)
static_df$Outcome <- gsub("_", " ", static_df$Outcome)
static_df$Outcome <- tools::toTitleCase(static_df$Outcome)

# Display static effects
knitr::kable(static_df,
    digits = 3,
    caption = "Static Treatment Effects of Cursor Adoption (DiD Imputation)"
)
```

## Dynamic Treatment Effects (Event Study)

```{r dynamic_analysis}
# Function to run dynamic analysis for a given outcome
run_dynamic_analysis <- function(outcome_var, data) {
    # Run didimputation with horizon parameter for -6 to 6 months
    dynamic_result <- did_imputation(
        data = data,
        yname = outcome_var,
        gname = "event",
        tname = "time",
        idname = "repo_name",
        first_stage = ~ age + ncloc + contributors + stars + issues | repo_name + time,
        horizon = -6:6,
        pretrends = -6:-1
    )

    return(dynamic_result)
}

# Run dynamic analysis for each outcome
dynamic_results <- list()
for (var in outcome_vars) {
    cat("Running dynamic analysis for:", var, "\n")
    dynamic_results[[var]] <- run_dynamic_analysis(var, panel_data)
}
```

```{r event_study, fig.width=12, fig.height=8}
# Function to plot event study for a given outcome
plot_event_study <- function(did_result, title) {
    # Filter for dynamic effects (exclude static "treat" term only)
    dynamic_data <- did_result[did_result$term != "treat", ]

    if (nrow(dynamic_data) == 0) {
        cat("No dynamic effects available for", title, "\n")
        return(NULL)
    }

    # Create a data frame for plotting
    plot_data <- data.frame(
        time = as.numeric(dynamic_data$term),
        estimate = dynamic_data$estimate,
        conf.low = dynamic_data$conf.low,
        conf.high = dynamic_data$conf.high,
        is_significant = (dynamic_data$conf.low > 0) | (dynamic_data$conf.high < 0)
    )

    # Plot
    ggplot(plot_data, aes(x = time, y = estimate)) +
        geom_point(aes(shape = is_significant), size = 3) +
        scale_shape_manual(values = c("FALSE" = 1, "TRUE" = 16),
                          labels = c("FALSE" = "Not Significant", "TRUE" = "Significant *")) +
        geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
        geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
        geom_vline(xintercept = 0, linetype = "dashed", color = "blue") +
        scale_x_continuous(limits = c(-6, 6), breaks = -6:6) +
        labs(
            title = paste("Event Study:", title),
            x = "Months Relative to Cursor Adoption",
            y = "Treatment Effect",
            shape = "Significance"
        ) +
        theme_minimal()
}

# Create plot list (only include valid plots)
plot_list <- list()
for (i in seq_along(outcome_vars)) {
    if (outcome_vars[i] %in% names(dynamic_results)) {
        plot_obj <- plot_event_study(dynamic_results[[outcome_vars[i]]], outcome_names[i])
        if (!is.null(plot_obj)) {
            plot_list[[length(plot_list) + 1]] <- plot_obj
        }
    }
}

# Combine plots if we have any
if (length(plot_list) > 0) {
    if (length(plot_list) == 1) {
        # If only one plot, just display it
        plot_list[[1]]
    } else {
        # If multiple plots, use grid.arrange
        gridExtra::grid.arrange(grobs = plot_list, ncol = 2)
    }
}
```

## Treatment Effect Heterogeneity Analysis

```{r heterogeneity_setup}
# Create heterogeneity variables
# 1. Early vs Late Adopters (based on median adoption time)
median_adoption_time <- median(panel_data$event[panel_data$event > 0])
panel_data$early_adopter <- ifelse(panel_data$event > 0 & panel_data$event <= median_adoption_time, 1, 0)
panel_data$late_adopter <- ifelse(panel_data$event > median_adoption_time, 1, 0)

# 2. Young vs Old Projects (based on median project age at treatment)
# Calculate age at treatment for treated units
panel_data$age_at_treatment <- ifelse(panel_data$event > 0,
                                     panel_data$age, NA)
median_age_at_treatment <- median(panel_data$age_at_treatment[panel_data$event > 0], na.rm = TRUE)
panel_data$young_project <- ifelse(panel_data$event > 0 & panel_data$age_at_treatment <= median_age_at_treatment, 1, 0)
panel_data$old_project <- ifelse(panel_data$event > 0 & panel_data$age_at_treatment > median_age_at_treatment, 1, 0)

# 3. Small vs Large Projects (based on median ncloc at treatment)
panel_data$ncloc_at_treatment <- ifelse(panel_data$event > 0,
                                       panel_data$ncloc, NA)
median_ncloc_at_treatment <- median(panel_data$ncloc_at_treatment[panel_data$event > 0], na.rm = TRUE)
panel_data$small_project <- ifelse(panel_data$event > 0 & panel_data$ncloc_at_treatment <= median_ncloc_at_treatment, 1, 0)
panel_data$large_project <- ifelse(panel_data$event > 0 & panel_data$ncloc_at_treatment > median_ncloc_at_treatment, 1, 0)

# Print summary statistics
cat("Heterogeneity Group Summary:\n")
cat("Early adopters:", sum(panel_data$early_adopter, na.rm = TRUE), "observations\n")
cat("Late adopters:", sum(panel_data$late_adopter, na.rm = TRUE), "observations\n")
cat("Young projects:", sum(panel_data$young_project, na.rm = TRUE), "observations\n")
cat("Old projects:", sum(panel_data$old_project, na.rm = TRUE), "observations\n")
cat("Small projects:", sum(panel_data$small_project, na.rm = TRUE), "observations\n")
cat("Large projects:", sum(panel_data$large_project, na.rm = TRUE), "observations\n")
```

```{r heterogeneity_analysis}
# Function to run DiD analysis for a specific subgroup
run_subgroup_did <- function(outcome_var, data, subgroup_var) {
    # Filter data to include only the specific subgroup and control group
    subgroup_data <- data[data[[subgroup_var]] == 1 | data$treated == 0, ]

    if (nrow(subgroup_data) < 50) {
        return(NULL)  # Skip if too few observations
    }

    # Create new treatment indicator for this subgroup
    subgroup_data$subgroup_treated <- ifelse(subgroup_data[[subgroup_var]] == 1, 1, 0)

    # Run DiD analysis
    tryCatch({
        did_result <- did_imputation(
            data = subgroup_data,
            yname = outcome_var,
            gname = "event",
            tname = "time",
            idname = "repo_name",
            first_stage = ~ age + ncloc + contributors + stars + issues | repo_name + time
        )
        return(did_result)
    }, error = function(e) {
        cat("Error in subgroup analysis for", outcome_var, ":", e$message, "\n")
        return(NULL)
    })
}

# Function to extract treatment effect from DiD result
extract_treatment_effect <- function(did_result) {
    if (is.null(did_result)) return(list(estimate = NA, se = NA, p_value = NA))

    treat_row <- did_result[did_result$term == "treat", ]
    if (nrow(treat_row) == 0) return(list(estimate = NA, se = NA, p_value = NA))

    return(list(
        estimate = treat_row$estimate,
        se = treat_row$std.error,
        p_value = treat_row$p.value
    ))
}

# Function to perform difference test between two subgroups
difference_test <- function(est1, se1, est2, se2) {
    if (is.na(est1) || is.na(est2) || is.na(se1) || is.na(se2)) {
        return(list(diff = NA, se_diff = NA, t_stat = NA, p_value = NA))
    }

    diff <- est1 - est2
    se_diff <- sqrt(se1^2 + se2^2)
    t_stat <- diff / se_diff
    p_value <- 2 * (1 - pnorm(abs(t_stat)))

    return(list(diff = diff, se_diff = se_diff, t_stat = t_stat, p_value = p_value))
}

# Function to calculate effect size (Cohen's d)
effect_size <- function(est1, est2, se1, se2) {
    if (is.na(est1) || is.na(est2) || is.na(se1) || is.na(se2)) {
        return(NA)
    }

    # Pooled standard error
    pooled_se <- sqrt((se1^2 + se2^2) / 2)
    cohens_d <- (est1 - est2) / pooled_se

    return(cohens_d)
}

# Define heterogeneity groups
heterogeneity_groups <- list(
    list(name = "Early vs Late Adopters",
         group1 = "early_adopter", group2 = "late_adopter"),
    list(name = "Young vs Old Projects",
         group1 = "young_project", group2 = "old_project"),
    list(name = "Small vs Large Projects",
         group1 = "small_project", group2 = "large_project")
)

# Run heterogeneity analysis for each group and outcome
heterogeneity_results <- list()

for (group_info in heterogeneity_groups) {
    group_name <- group_info$name
    group1_var <- group_info$group1
    group2_var <- group_info$group2

    cat("\n=== Analysis for", group_name, "===\n")

    group_results <- list()

    for (i in seq_along(outcome_vars)) {
        outcome_var <- outcome_vars[i]
        outcome_name <- outcome_names[i]

        cat("Running analysis for:", outcome_name, "\n")

        # Run DiD for both subgroups
        result1 <- run_subgroup_did(outcome_var, panel_data, group1_var)
        result2 <- run_subgroup_did(outcome_var, panel_data, group2_var)

        # Extract treatment effects
        effect1 <- extract_treatment_effect(result1)
        effect2 <- extract_treatment_effect(result2)

        # Perform difference test
        diff_test <- difference_test(effect1$estimate, effect1$se,
                                   effect2$estimate, effect2$se)

        # Calculate effect size
        cohens_d <- effect_size(effect1$estimate, effect2$estimate,
                               effect1$se, effect2$se)

        # Store results
        group_results[[outcome_name]] <- list(
            group1_estimate = effect1$estimate,
            group1_se = effect1$se,
            group1_pvalue = effect1$p_value,
            group2_estimate = effect2$estimate,
            group2_se = effect2$se,
            group2_pvalue = effect2$p_value,
            difference = diff_test$diff,
            diff_se = diff_test$se_diff,
            diff_tstat = diff_test$t_stat,
            diff_pvalue = diff_test$p_value,
            cohens_d = cohens_d
        )
    }

    heterogeneity_results[[group_name]] <- group_results
}
```

```{r heterogeneity_summary}
# Create summary tables for each heterogeneity dimension
create_heterogeneity_table <- function(group_name, group_results) {
    # Check if group_results is empty or NULL
    if (is.null(group_results) || length(group_results) == 0) {
        cat("No results available for", group_name, "\n")
        return(NULL)
    }

    # Extract data for table
    outcomes <- names(group_results)

    # Check if we have valid outcomes
    if (length(outcomes) == 0) {
        cat("No valid outcomes for", group_name, "\n")
        return(NULL)
    }

    # Safely extract values with error handling
    safe_extract <- function(field) {
        sapply(group_results, function(x) {
            if (is.null(x) || is.null(x[[field]])) NA else x[[field]]
        })
    }

    table_data <- data.frame(
        Outcome = outcomes,
        Group1_Estimate = safe_extract("group1_estimate"),
        Group1_SE = safe_extract("group1_se"),
        Group1_PValue = safe_extract("group1_pvalue"),
        Group2_Estimate = safe_extract("group2_estimate"),
        Group2_SE = safe_extract("group2_se"),
        Group2_PValue = safe_extract("group2_pvalue"),
        Difference = safe_extract("difference"),
        Diff_SE = safe_extract("diff_se"),
        Diff_PValue = safe_extract("diff_pvalue"),
        Cohens_D = safe_extract("cohens_d")
    )

    # Add significance indicators
    table_data$Group1_Sig <- ifelse(table_data$Group1_PValue < 0.05, "*", "")
    table_data$Group2_Sig <- ifelse(table_data$Group2_PValue < 0.05, "*", "")
    table_data$Diff_Sig <- ifelse(table_data$Diff_PValue < 0.05, "*", "")

    return(table_data)
}

# Combine all heterogeneity results into one large table
combined_table_data <- data.frame()

for (group_name in names(heterogeneity_results)) {
    table_data <- create_heterogeneity_table(group_name, heterogeneity_results[[group_name]])

    # Check if table_data is valid
    if (is.null(table_data) || nrow(table_data) == 0) {
        cat("No valid data available for", group_name, "\n")
        next
    }

    # Add dimension column
    table_data$Heterogeneity_Dimension <- group_name

    # Add to combined table
    combined_table_data <- rbind(combined_table_data, table_data)
}

display_table <- combined_table_data[, c("Heterogeneity_Dimension", "Outcome",
                                        "Group1_Estimate", "Group1_SE", "Group1_Sig",
                                        "Group2_Estimate", "Group2_SE", "Group2_Sig",
                                        "Difference", "Diff_SE", "Diff_PValue", "Diff_Sig", "Cohens_D")]

# Rename columns for better readability
colnames(display_table) <- c("Dimension", "Outcome", "Group1_Est", "Group1_SE", "Group1_Sig",
                            "Group2_Est", "Group2_SE", "Group2_Sig",
                            "Difference", "Diff_SE", "Diff_PValue", "Diff_Sig", "Cohen's d")

# Display combined table
knitr::kable(display_table,
                digits = 3,
                caption = "Treatment Effect Heterogeneity by Outcome Variable and Group")
```
