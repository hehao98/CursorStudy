---
title: "The Impact of Cursor Adoption on Velocity and Quality - Borusyak et al. (2021) DiD Approach"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(dev = 'CairoPNG', dpi = 150)
options(bitmapType = 'cairo')
utils::globalVariables(c(
    "estimate", "is_significant", "conf.low", "conf.high",
    "term", "setting", "outcome", "outcome_label", "time"
))
```

## Loading Required Packages

```{r load_packages}
library(didimputation)
library(tidyverse)
library(ggplot2)
library(data.table)
library(modelsummary)
library(fixest)
library(gridExtra)
library(Cairo)
```

## Loading and Preparing the Data

```{r load_data}
panel_data <- fread("../data/panel_event_monthly.csv")

# Load repo metrics data for cursor adoption percentages
repo_metrics <- fread("../data/repo_metrics.csv")

# Convert variables to DiD required format
# Keep original repo names (strings) for mapping
panel_data$repo_name_str <- panel_data$repo_name
panel_data$repo_name <- as.numeric(factor(panel_data$repo_name))
panel_data$time <- as.numeric(gsub("-", "", panel_data$time))
panel_data$event[!is.na(panel_data$event)] <- as.numeric(
    gsub("-", "", panel_data$event[!is.na(panel_data$event)]))
panel_data$event[is.na(panel_data$event)] <- 0
panel_data <- panel_data[panel_data$event < 202401 # never treated
        | (panel_data$event > 202407 & panel_data$event <= 202503)]
panel_data$event <- as.integer(panel_data$event)
panel_data$quality_warnings <- panel_data$code_smells + panel_data$vulnerabilities + panel_data$bugs

# Log transform skewed variables
panel_data$commits <- log(panel_data$commits + 1)
panel_data$lines_added <- log(panel_data$lines_added + 1)
panel_data$quality_warnings <- log(panel_data$quality_warnings + 1)
panel_data$cognitive_complexity <- log(panel_data$cognitive_complexity + 1)
panel_data$duplicated_lines_density <- log(panel_data$duplicated_lines_density + 1)
panel_data$comment_lines_density <- log(panel_data$comment_lines_density + 1)
panel_data$age <- log(panel_data$age + 1)
panel_data$contributors <- log(panel_data$contributors + 1)
panel_data$stars <- log(panel_data$stars + 1)
panel_data$issues <- log(panel_data$issues + 1)
panel_data$issue_comments <- log(panel_data$issue_comments + 1)

# Create treatment indicator and time since treatment variables
panel_data$treated <- ifelse(panel_data$event > 0, 1, 0)
panel_data$time_since_treatment <- ifelse(panel_data$treated == 1,
                                         panel_data$time - panel_data$event,
                                         NA)

# Build simple mapping: repo_name -> cursor adoption %
adoption_pct <- setNames(repo_metrics$cursor_adoptor_percentage, repo_metrics$repo_name)

glimpse(panel_data)
```

## DiD Analysis with DiD Imputation Package

```{r did_analysis}
# List of outcome variables
outcome_vars <- c(
    "commits",
    "lines_added",
    "quality_warnings",
    # "comment_lines_density",
    "duplicated_lines_density",
    "cognitive_complexity"
)
outcome_names <- c(
    "Commits",
    "Lines Added",
    "Static Analysis Warnings",
    # "Comment Lines Density",
    "Duplicated Lines Density",
    "Code Complexity"
)
```

## Aggregate Treatment Effects

```{r aggregate_effects}
# Function to extract static treatment effects (overall effect)
get_static_effects <- function(outcome_var, data) {
    # Run static DiD (no horizon/pretrends specified)
    static_result <- did_imputation(
        data = data,
        yname = outcome_var,
        gname = "event",
        tname = "time",
        idname = "repo_name",
        first_stage = ~ age + ncloc + contributors + stars + issues | repo_name + time
    )

    return(static_result)
}

# Calculate static effects for each outcome
static_results <- list()
for (var in outcome_vars) {
    static_results[[var]] <- get_static_effects(var, panel_data)
}

# Create a dataframe with all static effects
static_df <- data.frame(
    Outcome = names(static_results),
    Estimate = sapply(static_results, function(x) x$estimate[x$term == "treat"]),
    SE = sapply(static_results, function(x) x$std.error[x$term == "treat"]),
    CI_Lower = sapply(static_results, function(x) x$conf.low[x$term == "treat"]),
    CI_Upper = sapply(static_results, function(x) x$conf.high[x$term == "treat"])
)

# Clean outcome names for display
static_df$Outcome <- gsub("log\\((.+) \\+ 1\\)", "\\1", static_df$Outcome)
static_df$Outcome <- gsub("_", " ", static_df$Outcome)
static_df$Outcome <- tools::toTitleCase(static_df$Outcome)

# Display static effects
knitr::kable(static_df,
    digits = 3,
    caption = "Static Treatment Effects of Cursor Adoption (DiD Imputation)"
)
```

## Dynamic Treatment Effects (Event Study)

```{r dynamic_analysis}
# Function to run dynamic analysis for a given outcome
run_dynamic_analysis <- function(outcome_var, data) {
    # Run didimputation with horizon parameter for -6 to 6 months
    dynamic_result <- did_imputation(
        data = data,
        yname = outcome_var,
        gname = "event",
        tname = "time",
        idname = "repo_name",
        first_stage = ~ age + ncloc + contributors + stars + issues | repo_name + time,
        horizon = -6:6,
        pretrends = -6:-2
    )

    return(dynamic_result)
}

# Run dynamic analysis for each outcome
dynamic_results <- list()
for (var in outcome_vars) {
    cat("Running dynamic analysis for:", var, "\n")
    dynamic_results[[var]] <- run_dynamic_analysis(var, panel_data)
}
```

```{r event_study, fig.width=12, fig.height=8}
# Function to plot event study for a given outcome
plot_event_study <- function(did_result, title) {
    # Filter for dynamic effects (exclude static "treat" term only)
    dynamic_data <- did_result[did_result$term != "treat", ]

    if (nrow(dynamic_data) == 0) {
        cat("No dynamic effects available for", title, "\n")
        return(NULL)
    }

    # Create a data frame for plotting
    plot_data <- data.frame(
        time = as.numeric(dynamic_data$term),
        estimate = dynamic_data$estimate,
        conf.low = dynamic_data$conf.low,
        conf.high = dynamic_data$conf.high,
        is_significant = (dynamic_data$conf.low > 0) | (dynamic_data$conf.high < 0)
    )

    # Plot
    ggplot(plot_data, aes(x = time, y = estimate)) +
        geom_point(aes(shape = is_significant), size = 3) +
        scale_shape_manual(values = c("FALSE" = 1, "TRUE" = 16),
                          labels = c("FALSE" = "Not Significant", "TRUE" = "Significant *")) +
        geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
        geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
        geom_vline(xintercept = 0, linetype = "dashed", color = "blue") +
        scale_x_continuous(limits = c(-6, 6), breaks = -6:6) +
        labs(
            title = paste("Event Study:", title),
            x = "Months Relative to Cursor Adoption",
            y = "Treatment Effect",
            shape = "Significance"
        ) +
        theme_minimal()
}

# Create plot list (only include valid plots)
plot_list <- list()
for (i in seq_along(outcome_vars)) {
    if (outcome_vars[i] %in% names(dynamic_results)) {
        plot_obj <- plot_event_study(dynamic_results[[outcome_vars[i]]], outcome_names[i])
        if (!is.null(plot_obj)) {
            plot_list[[length(plot_list) + 1]] <- plot_obj
        }
    }
}

# Combine plots if we have any
if (length(plot_list) > 0) {
    if (length(plot_list) == 1) {
        # If only one plot, just display it
        plot_list[[1]]
    } else {
        # If multiple plots, use grid.arrange
        gridExtra::grid.arrange(grobs = plot_list, ncol = 2)
    }
}
```

## Compare Event Studies Across Five Settings

```{r compare_event_study, fig.width=11, fig.height=2.5}
# Build filtered variants directly from the already prepared `panel_data`
build_setting_variant <- function(data, setting_label) {
    dt <- data
    if (setting_label == "Active Months (>0 commits)") {
        # commits is log-transformed; > 0 corresponds to raw commits >= 1
        dt <- dt[dt$commits > 0, ]
    } else if (setting_label == "Very Active (>=10 commits)") {
        # commits is log-transformed; threshold at log(11)
        dt <- dt[dt$commits >= log(11), ]
    } else if (setting_label == "Truncated to 2025-06") {
        # `time` is numeric YYYYMM after preprocessing (e.g., 202506)
        dt <- dt[dt$time <= 202506, ]
    } else if (setting_label == "High Adoption (>=80%)") {
        # Only include treated repos with >=80% cursor adoption + never treated (control group)
        # Lookup using simple mapping from original repo_name strings
        adoption_vec <- adoption_pct[dt$repo_name_str]
        adoption_vec[is.na(adoption_vec)] <- 0
        dt <- dt[dt$treated == 0 | (dt$treated == 1 & adoption_vec >= 80), ]
    }
    dt
}

settings <- c(
    "Orginal",
    "Active Months (>0 commits)",
    "Very Active (>=10 commits)",
    "Truncated to 2025-06",
    "High Adoption (>=80%)"
)

# Run dynamic DiD for each outcome and each setting, collect results
collect_dynamic_results <- function(outcomes, settings) {
    results <- list()
    for (s in settings) {
        data_s <- build_setting_variant(panel_data, s)
        for (y in outcomes) {
            dyn <- didimputation::did_imputation(
                data = data_s,
                yname = y,
                gname = "event",
                tname = "time",
                idname = "repo_name",
                first_stage = ~ age + ncloc + contributors + stars + issues | repo_name + time,
                horizon = -6:6,
                pretrends = -6:-2
            )
            dyn$setting <- s
            dyn$outcome <- y
            results[[length(results) + 1]] <- dyn
        }
    }
    dplyr::bind_rows(results)
}

dyn_all <- collect_dynamic_results(outcome_vars, settings)

# Prepare data for plotting (exclude static treat term)
plot_dyn <- dyn_all[dyn_all$term != "treat", ]
plot_dyn$time <- as.numeric(plot_dyn$term)

# Map outcome codes to nice labels and enforce facet order (matches outcome_vars)
label_map <- setNames(outcome_names, outcome_vars)
plot_dyn$outcome_label <- label_map[plot_dyn$outcome]
plot_dyn$outcome_label <- factor(plot_dyn$outcome_label, levels = outcome_names)

# Keep legend order consistent with settings vector
plot_dyn$setting <- factor(plot_dyn$setting, levels = settings)

# Add significance indicator (CI not crossing 0 implies ~ p < 0.05)
plot_dyn$significant <- (plot_dyn$conf.low > 0) | (plot_dyn$conf.high < 0)

# Overlayed event study by setting, faceted by outcome (styled like DiffInDiffAll.Rmd)
dynamic_plot <- ggplot(plot_dyn, aes(x = time, y = estimate, color = setting)) +
    # Significant points (filled)
    geom_point(data = subset(plot_dyn, significant),
               position = position_dodge(width = 0.5), size = 1.5, shape = 19) +
    # Non-significant points (hollow)
    geom_point(data = subset(plot_dyn, !significant),
               position = position_dodge(width = 0.5), size = 1.5, shape = 21, fill = "transparent") +
    # Error bars for significant effects (solid)
    geom_errorbar(data = subset(plot_dyn, significant),
                  aes(ymin = conf.low, ymax = conf.high),
                  position = position_dodge(width = 0.5),
                  width = 0, linetype = "solid") +
    # Error bars for non-significant effects (dotted)
    geom_errorbar(data = subset(plot_dyn, !significant),
                  aes(ymin = conf.low, ymax = conf.high),
                  position = position_dodge(width = 0.5),
                  width = 0, linetype = "dotted") +
    geom_hline(yintercept = 0, linetype = "dashed") +
    geom_vline(xintercept = -0.5, linetype = "dashed") +
    scale_x_continuous(limits = c(-6, 6), breaks = -6:6) +
    labs(
        x = "Months Relative to Cursor Adoption",
        y = "Treatment Effect",
        color = "Setting",
        caption = "Filled dots: p < 0.05 (significant), Hollow dots: p â‰¥ 0.05 (non-significant)"
    ) +
    theme_minimal() +
    theme(
        legend.position = "bottom",
        plot.caption = element_text(hjust = 0.5, size = 10, margin = margin(t = 3)),
        legend.margin = margin(b = 3),
        legend.box.margin = margin(t = -5)
    ) +
    facet_wrap(~ outcome_label, scales = "free_y", nrow = 1, ncol = 5)

print(dynamic_plot)

ggsave("../plots/dynamic_effects_comparison.pdf",
  plot = dynamic_plot, width = 11, height = 2.5,
  device = CairoPDF, family = "DejaVu Sans")
```

## Poster Figures: Event Study with Percentage Changes

```{r poster_figures, fig.width=14, fig.height=9}
library(showtext)
library(ggfx)

font_add_google("Lato", "Lato")
showtext_auto()
showtext_opts(dpi = 300)

# Create a single-outcome poster plot
plot_poster_single <- function(outcome_var, outcome_name, y_label, y_limits = NULL) {
    dyn <- dynamic_results[[outcome_var]]
    df <- dyn[dyn$term != "treat", ]
    df$time <- as.numeric(df$term)

    # Ensure month -1 exists with zero effect
    if (!(-1 %in% df$time)) {
        new_row <- as.data.frame(as.list(setNames(rep(NA, ncol(df)), names(df))))
        new_row$term <- "-1"
        new_row$estimate <- 0
        new_row$std.error <- 0
        new_row$conf.low <- 0
        new_row$conf.high <- 0
        new_row$time <- -1
        df <- dplyr::bind_rows(df, new_row)
    }
    df <- df[order(df$time), ]

    # Convert to percentage changes
    df$pct_change <- (exp(df$estimate) - 1) * 100
    df$pct_low <- (exp(df$conf.low) - 1) * 100
    df$pct_high <- (exp(df$conf.high) - 1) * 100

    # Define colors for red background
    line_color <- "#E8F4F8"  # Light cyan
    text_color <- "#FFFFFF"  # White
    grid_color <- "#FFFFFF"  # White with transparency

    p <- ggplot(df, aes(x = time, y = pct_change)) +
        geom_hline(yintercept = 0, linetype = "solid", color = line_color, linewidth = 0.6) +
        geom_vline(xintercept = -0.5, linetype = "dashed", color = line_color, linewidth = 0.9) +
        with_shadow(geom_ribbon(aes(ymin = pct_low, ymax = pct_high), fill = line_color, alpha = 0.3),
                    sigma = 2, x_offset = 1, y_offset = 1, color = "black") +
        with_shadow(geom_line(linewidth = 1.8, color = line_color),
                    sigma = 2, x_offset = 1, y_offset = 1, color = "black") +
        with_shadow(geom_point(size = 4, shape = 16, color = line_color),
                    sigma = 2, x_offset = 1, y_offset = 1, color = "black") +
        scale_x_continuous(limits = c(-6, 6), breaks = -6:6) +
        labs(x = "Months Relative to Cursor Adoption", y = y_label) +
        theme_minimal(base_size = 12, base_family = "Lato") +
        theme(
            plot.title = element_text(face = "bold", size = 12, hjust = 0.5, color = text_color),
            axis.title = element_text(face = "bold", size = 12, color = text_color),
            axis.text = element_text(face = "bold", size = 12, color = text_color),
            axis.line = element_line(color = text_color, linewidth = 0.6),
            axis.ticks = element_line(color = text_color, linewidth = 0.5),
            panel.grid.minor = element_blank(),
            panel.grid.major = element_line(color = grid_color, linewidth = 0.25, alpha = 0.25),
            plot.margin = margin(15, 15, 15, 15),
            panel.background = element_rect(fill = "transparent", colour = NA),
            plot.background = element_rect(fill = "transparent", colour = NA)
        )

    if (!is.null(y_limits)) {
        p <- p + coord_cartesian(ylim = y_limits, clip = "off")
    }

    return(p)
}

# Generate four independent figures
commits_plot <- plot_poster_single(
    outcome_var = "commits", outcome_name = "Commits",
    y_label = "Effect on Commits (%)",
    y_limits = c(-30, 100)
)
lines_added_plot <- plot_poster_single(
    outcome_var = "lines_added", outcome_name = "Lines Added",
    y_label = "Effect on Lines Added (%)",
    y_limits = c(-50, 400)
)
tool_warnings_plot <- plot_poster_single(
    outcome_var = "quality_warnings", outcome_name = "Tool Warnings",
    y_label = "Effect on Technical Debt (%)",
    y_limits = c(-25, 75)
)
complexity_plot <- plot_poster_single(
    outcome_var = "cognitive_complexity", outcome_name = "Cognitive Complexity",
    y_label = "Effect on Code Complexity (%)",
    y_limits = c(-25, 75)
)
# Save individual PNGs (transparent)
output_width <- 4
output_height <- 3
ggsave("../plots/poster_commits_event_study.png", commits_plot,
       width = output_width, height = output_height, dpi = 300, bg = "transparent")
ggsave("../plots/poster_lines_added_event_study.png", lines_added_plot,
       width = output_width, height = output_height, dpi = 300, bg = "transparent")
ggsave("../plots/poster_tool_warnings_event_study.png", tool_warnings_plot,
       width = output_width, height = output_height, dpi = 300, bg = "transparent")
ggsave("../plots/poster_cognitive_complexity_event_study.png", complexity_plot,
       width = output_width, height = output_height, dpi = 300, bg = "transparent")
```
