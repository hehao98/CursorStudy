---
title: "The Impact of Cursor Adoption on Velocity and Quality"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Loading Required Packages

```{r load_packages}
library(fixest)
library(tidyverse)
library(ggplot2)
library(data.table)
library(modelsummary)
library(corrplot)
```

## Loading and Preparing the Data

```{r load_data}
panel_data <- fread("../data/panel_event_monthly.csv")

# panel_data <- panel_data[panel_data$is_treatment == 1] # only treatment group
# panel_data <- panel_data[panel_data$commits > 0] # exclude inactive months

# Compute churn
#panel_data$churn <- panel_data$lines_removed / panel_data$lines_added

# Alternative code quality metrics
panel_data <- panel_data %>%
  arrange(repo_name, time) %>%
  group_by(repo_name) %>%
  mutate(
    delta_code_smells = code_smells - lag(code_smells),
    delta_vulnerabilities = vulnerabilities - lag(vulnerabilities),
    delta_bugs = bugs - lag(bugs)
  ) %>%
  ungroup()

panel_data$repo_name <- as.factor(panel_data$repo_name)
panel_data$time <- as.factor(panel_data$time)

glimpse(panel_data)
```

## Define Outcome Variables

```{r define_outcome_variables}
outcome_variables_its <- c(
    "log(commits + 1)" = "Commits",
    "log(lines_added + 1)" = "Lines Added",
    #"log(churn + 1)" = "Churn",
    "log(code_smells + 1)" = "Code Smells",
    "log(vulnerabilities + 1)" = "Vulnerabilities",
    "log(bugs + 1)" = "Bugs",
    "comment_lines_density" = "Comment Lines Density",
    "duplicated_lines_density" = "Duplicated Lines",
    "log(cognitive_complexity + 1)" = "Cognitive Complexity"
)

outcome_variables <- c(
    "log(commits + 1)" = "Commits",
    "log(lines_added + 1)" = "Lines Added",
    #"log(churn + 1)" = "Churn",
    "log(delta_code_smells + 1)" = "New Code Smells",
    "log(delta_vulnerabilities + 1)" = "New Vulnerabilities",
    "log(delta_bugs + 1)" = "New Bugs",
    "comment_lines_density" = "Comment Lines Density",
    "duplicated_lines_density" = "Duplicated Lines",
    "log(cognitive_complexity + 1)" = "Cognitive Complexity"
)
```

## Correlation Analysis of Covariates

```{r correlation_analysis}
# Select covariates
covariates <- panel_data[, c("ncloc", "age", "contributors", "stars", "issues", "issue_comments")]

# Compute correlation matrix
cor_matrix <- cor(covariates, use = "pairwise.complete.obs")

# Display correlation matrix
knitr::kable(round(cor_matrix, 3), caption = "Correlation Matrix of Covariates")

# Visualization of correlation matrix
corrplot(cor_matrix,
    method = "circle", type = "upper",
    tl.col = "black", tl.srt = 45,
    title = "Correlation Plot of Covariates",
    mar = c(0, 0, 1, 0)
)
```

## Base DiD Model

```{r base_did_model}
fit_did_model <- function(outcome_var, data) {
    formula_str <- paste0(
        outcome_var, " ~ post_event + log(ncloc + 1) + log(age + 1) +
    log(contributors + 1) + log(stars + 1) +
    log(issues + 1) | repo_name + time"
    )

    model <- feols(as.formula(formula_str), data = data)
    return(model)
}

fit_multiple_did_models <- function(outcome_vars, data) {
    models_list <- list()

    for (outcome in names(outcome_vars)) {
        models_list[[outcome_vars[outcome]]] <- fit_did_model(outcome, data)
    }

    return(models_list)
}

did_models <- fit_multiple_did_models(outcome_variables, panel_data)

modelsummary(did_models,
    title = "Impact of Cursor Adoption on Development Metrics",
    stars = TRUE,
    gof_omit = "AIC|BIC|RMSE|FE|R2 Within Adj.|(R2$)|Std",
    coef_map = c(
        "post_event" = "Post Cursor Adoption",
        "log(ncloc + 1)" = "Log Lines of Code",
        "log(age + 1)" = "Log Age (days)",
        "log(contributors + 1)" = "Log Contributors",
        "log(stars + 1)" = "Log Stars",
        "log(issues + 1)" = "Log Issues",
        "log(issue_comments + 1)" = "Log Issue Comments"
    ),
    fmt = 3,
    estimate = "{estimate}{stars}"
)
```

## Interrupted Time Series

```{r its_setup}
its_data <- panel_data %>%
  group_by(repo_name) %>%
  mutate(
    time_numeric = as.numeric(as.factor(time)),
    intervention = post_event,
    time_after_intervention = ifelse(post_event == 1, time_numeric - min(time_numeric[post_event == 1]), 0)
  ) %>%
  ungroup()
```

```{r its_models}
# Function to fit ITS model
fit_its_model <- function(outcome_var, data) {
  formula_str <- paste0(
    outcome_var, " ~ time_numeric + intervention + time_after_intervention +
    log(ncloc + 1) + log(age + 1) + log(contributors + 1) + log(stars + 1) + log(issues + 1)"
  )

  model <- feols(as.formula(formula_str), data = data)

  return(model)
}

# Fit ITS models for each outcome
its_models <- list()
for (outcome in names(outcome_variables_its)) {
  its_models[[outcome_variables_its[outcome]]] <- fit_its_model(outcome, its_data)
}

# Create coefficient map with better labels
cm <- c(
  "time_numeric" = "Time",
  "intervention" = "Intervention (Post Cursor)",
  "time_after_intervention" = "Time After Intervention",
  "log(ncloc + 1)" = "Log Lines of Code",
  "log(age + 1)" = "Log Age (days)",
  "log(contributors + 1)" = "Log Contributors",
  "log(stars + 1)" = "Log Stars",
  "log(issues + 1)" = "Log Issues"
)

# Generate model summary table
modelsummary(
  its_models,
  title = "Interrupted Time Series Models: Effects of Cursor Adoption",
  stars = TRUE,
  gof_map = c("nobs", "r.squared", "adj.r.squared"),
  coef_map = cm,
  fmt = 3
)
```

## Panel Event Study Models

```{r panel_event_study, fig.width=12, fig.height=12}
# Function to fit event study model
fit_event_study <- function(outcome_var, data) {
    formula_str <- paste0(
        outcome_var, " ~ lead_6 + lead_5 + lead_4 + lead_3 + lead_2 +
        lag_0 + lag_1 + lag_2 + lag_3 + lag_4 + lag_5 + lag_6 +
        log(ncloc + 1) + log(age + 1) + log(contributors + 1) + log(stars + 1) +
        log(issues + 1) | repo_name + time"
    )

    model <- feols(as.formula(formula_str), data = data)
    return(model)
}

# Fit models for each outcome
event_models <- list(
    commits = fit_event_study("log(commits + 1)", panel_data),
    lines = fit_event_study("log(lines_added + 1)", panel_data),
    new_code_smells = fit_event_study("log(delta_code_smells + 1)", panel_data),
    new_bugs = fit_event_study("log(delta_bugs + 1)", panel_data),
    complexity = fit_event_study("log(cognitive_complexity + 1)", panel_data),
    duplicated_lines_density = fit_event_study("duplicated_lines_density", panel_data)
)

# Function to extract coefficients and CIs
get_event_data <- function(model, outcome_name) {
    coefs <- coef(model)
    ci <- confint(model)
    pvals <- summary(model)$coeftable[, 4]

    time_periods <- c(-6:6)  # Changed to include 0
    estimates <- numeric(length(time_periods))
    conf_low <- numeric(length(time_periods))
    conf_high <- numeric(length(time_periods))
    p_values <- numeric(length(time_periods))
    is_significant <- logical(length(time_periods))

    for (i in seq_along(time_periods)) {
        t <- time_periods[i]
        var_name <- if (t < 0) paste0("lead_", abs(t)) else paste0("lag_", t)

        estimates[i] <- coefs[var_name]
        conf_low[i] <- ci[var_name, 1]
        conf_high[i] <- ci[var_name, 2]
        p_values[i] <- pvals[var_name]

        # Determine significance (p < 0.05)
        is_significant[i] <- p_values[i] < 0.05
    }

    data.frame(
        time = time_periods,
        estimate = estimates,
        conf.low = conf_low,
        conf.high = conf_high,
        p_value = p_values,
        is_significant = is_significant,
        outcome = outcome_name
    )
}

# Combine all results
plot_data <- rbind(
    get_event_data(event_models$commits, "Commits"),
    get_event_data(event_models$lines, "Lines Added"),
    get_event_data(event_models$new_code_smells, "New Code Smells"),
    get_event_data(event_models$new_bugs, "New Bugs"),
    get_event_data(event_models$complexity, "Cognitive Complexity"),
    get_event_data(event_models$duplicated_lines_density, "Duplicated Lines Density")
)

# Plot all outcomes
ggplot(plot_data, aes(x = time, y = estimate, color = outcome)) +
    # Use different shapes based on significance
    geom_point(aes(shape = is_significant), size = 3, position = position_dodge(width = 0.3)) +
    scale_shape_manual(values = c("FALSE" = 1, "TRUE" = 16)) + # 1=hollow circle, 16=filled circle
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
        width = 0.2,
        position = position_dodge(width = 0.3)
    ) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "blue") +
    facet_wrap(~outcome, scales = "free_y", nrow = 3, ncol = 2) +
    labs(
        title = "Event Study: Effects of Cursor Adoption",
        x = "Months Relative to Adoption",
        y = "Coefficient Estimate",
        color = "Outcome",
        shape = "Significant (p<0.05)"
    ) +
    theme_minimal() +
    theme(
        legend.position = "bottom",
        legend.box = "horizontal",
        plot.subtitle = element_text(size = 10, color = "darkblue")
    )
```
